---
author: "li_mingxie"
title: "【区块链】以太坊2.0权益证明(共识)"
date: 2099-11-30T23:28:49+08:00
tags: [
    "区块链",
    "blockchain",
    "ETH",
    "ethereum",
    "white paper",
]
categories: [
    "eth",
    "blockchain",
]
---

这几天看了解以太坊的权益证明。  
官网的文档几乎都是叙述性的翻译，看的好难受。  
也找了很多材料，顺便整理一下后续可以参考回顾。  <!--more-->  

官网文档地址：  
中文版： https://ethereum.org/zh/developers/docs/consensus-mechanisms/pos/  
英文版： https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/  

## 1.共识机制

说起权益证明之前，我们先需要了解共识机制。  

### 1.1 什么是共识？

共识说白了就是，一群人在一起，达成一致的意见。  
比如，一群人去看电影，如果他们“看某部电影”没有任何异议，就可以说达成共识了。  
如果存在异议，他们必须通过某种方法(投票)决定看哪一部电影。  
在极端情况下，这群人会分开(分叉)。

在区块链领域，共识的意义是在一个区块链网络中，所有节点都能看到相同的区块链状态。  
在以太坊达成共识的过程是标准化的，共识意味着全网络中至少66%的节点状态达成一致。  

### 1.2 什么是共识机制？

共识机制是一整套由协议、激励和想法构成的`体系`，使得整个区块链网络节点的状态达成一致。  
大部分区块链的共识机制是用工作量证明(POW)或是权益证明(POS)来实现的。  

#### 工作量证明(POW)

比特币采用的是工作量证明，其原理是每个节点都算hash值。  
根据难度，能算出满足该难度的节点抢先出块，获得奖励。  
其实就是不停的换区块的nonce值，看算出来的区块hash值的前面有几个0，难度越高需要的0越多。  

#### 权益证明(POS)

以太坊现在用的是权益证明。  
其原理是根据其在网络中的权益(质押的ETH数量)，  
通过随机抽样算法(RANDAO)选择一个验证者成为区块提议者出块。  

## 2.什么是权益证明？

2022年9月15日以太坊合并完成，主网与PoS共识层信标链（Beacon链）结合、将此前PoW工作量证明机制转变为PoS权益证明机制，宣布以太坊正式进入2.0时代。
权益证明是一种新的共识机制，它是基于权益的概念。  

### 2.1 验证者validator

要想作为验证者参与治理，用户必须向存款合约中存入32个以太币并运行三种独立的软件：执行客户端、共识客户端和验证器。 存入以太币时，用户会进入一个激活队列，限制新验证者加入网络的速度。 激活后，验证者将从以太坊网络上的对等节点接收新区块。 区块中的交易会被重新执行，以检查对以太坊状态的更改建议是否有效，并且会检查区块的签名。 然后验证者在整个网络上发送支持该区块的投票（称为认证）。

在工作量证明中，生成区块的时间是由挖矿难度决定的，而在权益证明中，节奏是固定的。 权益证明以太坊中的时间分为时隙（12 秒）和时段（32 个时隙）。 在每个时隙中随机选择一位验证者作为区块提议者。 该验证者负责创建新区块并发送给网络上的其他节点。 另外在每个时隙中，都会随机选择一个验证者委员会，通过他们的投票确定所提议区块的有效性。 将验证者集合划分为若干个委员会对于保持网络负荷易于管理非常重要。 委员会将验证者集合分成不同部分，以便每个活跃的验证者在每个时段都会出示证明，但并不在每个时隙都这样做。

### 2.2 交易流程

### 2.3 最终确定性finality

最终确定性是在给定时间之前，一组交易不会变更且无法回滚的保证。
交易在分布式网络中具有“最终确定性”是指，该交易是区块的一部分，而且除非销毁大量以太币，否则便无法改变。 在权益证明以太坊上，通过“检查点”区块来管理确定性。 每个时段中的第一个区块是检查点。 验证者为他们认为有效的“检查点对”投票。 如果一对检查点获得了质押以太币总数中三分之二以上的投票，那么这对检查点将被升级。 这两个（目标）中较新的一个会变成“合理”状态。 较旧的一个检查点已经是合理状态，因为它是上一个时段中的“目标”。 现在，这个检查点会升级为“最终确定”状态。

### 2.4 安全性  

### 2.5 分叉选择

### 2.6 工作量证明和权益证明的比较

### Epoch
A period of 32 slots, each slot being 12seconds, totalling 6.4 minutes. Validator committees are shuffled every epoch for security reasons. Each epoch has an opportunity for the chain to be finalized. Each validator is assigned new responsibilities at the start of each epoch. 

周期为32个时隙，每个时隙为12秒，总计6.4分钟。出于安全原因，验证器委员会在每个时代都被洗牌。每个epoch都有机会完成链。每个验证器在每个epoch开始时都被分配了新的职责。

以太坊用时段epoch来表示时间段，每个epoch由32个时隙slot组成，每个时隙slot大约12秒。
一般一个时隙slot包含一个区块block。
这样一个时段epoch为6分24秒。

每个时段epoch中，验证者只允许证明一个区块，否则会slashed。
如果摸个时隙slot的区块提议者没有提出块, 4秒以后，验证者们只投票前一个区块的attest。

BLS签名算法
允许数百个签名，聚合成一个签名，从而减少了签名的数量。
即使把验证者分成32个委员会，每个委员聚合这些签名也是一个庞大的数量。  
所以一个委员会进一步分为很多子网subnet。
每个子网subnet中，随机分配16？？个验证者生成一个BLS签名。
然后在聚合成一个最终的BLS签名，代表着这些验证者。

在每个时段epoch中，验证者会随机分到一个委员会，这个委员会committee负责在这个时段epoch中出示证明。

## 3.Gesper

在以太坊2.0链中，Casper 和 LMD GHOST 一起就构成了驱动以太坊2.0系统的共识协议。

LMD GHOST是一种新的权益证明机制，它在以太坊中被实现。
Last Message Driven Greediest Heaviest Observed SubTree
分叉选择规则
分叉选择规则是指在一个区块链网络中，如何选择一条链。

LMD GHOST 是以太坊2.0使用的分叉选择规则 (即用于决定哪条链是“权威链”的规则)，全称是“Last Message Driven Greediest Heaviest Observed SubTree (由最新消息驱动的GHOST)”
拥有最多投票的分叉链将被认为是“权威链(canonical chain)”


Casper FFG 是以太坊2.0使用的权益证明 (PoS) 机制，全称是“Casper the Friendly Finality Gadget (Casper 友好的最终性小工具)”
确保最终性finality
每个严重者都在检查点checkpoint投票


在以太坊2.0链中，每生成32个区块 (大约需要6.4分钟) 称为一个 epoch；

在以太坊 2.0 系统中，slot 是生成一个新区块所需的时间，即一个新区块被提议及证明其正确性所需的时间。每个 slot 被设定为12秒，但不是每个 Slot 期间都会产生新的区块。
在权益证明以太坊上，通过“检查点”区块来管理确定性。 每个时段epoch的第一个区块是检查点checkpoint。
每个 epoch 期间的最后一个 slot 被称为 checkpoint (检查点)。

Committee (委员会) 是由信标链在每个 slot 期间随机选择的验证者集合 (每个委员会的目标验证者数量是128名)，每个委员会中第一名被随机选择的验证者将有机会在该 slot 期间提议新区块，该委员会的其他验证者将对这个被提议的区块进行证明 (attest)。



LMD-GHOST 的規則很簡單：

- 從創世區塊開始；
- 每次有分叉，選擇票數多的分支；
- 重複，直至找到 block leaf；
- 返回鏈的頭部；


RANDAO随机算法

生成部分
1) R= VRF_Hash(SK，M)，每个节点基于自己的私钥信息以及最新的区块数据，通过VRF_Hash函数计算出随机数R
2) P= VRF_Proof(SK，M)，同样的参数也用来生成证明P
验证部分，如果某节点当选，全网可通过下列的两个证明函数来验证R的生成是否符合规范o
3) R=? VRF_P2H (P)
4) VRF_Verify(PK,M,P) =? True
至此一次可验证的抽签得以实现，这也是VRF命名的由来

VRF的简要版实现:
    生成部分
1) R = VRF_Hash(SK, M) = Hash(P)
2) P = VRF_Proof(SK, M) = Signature(SK, Hash(M))
    验证部分，如果某节点当选，全网拥有的可供验证的数据为R、P、PK、M
3) R=? VRF_P2H(P) => R=?Hash(P)
4) VRF_Verify(PK,M,P) =? True -用PK将P解出 =? Hash(M)


## 4.弱主观性 Weak Subjectivity


## 5.认证attestation

验证者需要在每个时段epoch创建、签名和广播认证。

### 5.1 什么是认证？

每个时段epoch(6.4 分钟)验证者都会向网络提议一个认证。这个认证是针对时段中的一个特定时隙slot。  
认证的目的是投票赞成验证者对于链的看法，特别是最近的合理区块和当前时段的第一个区块（被称为来源和目标检查点）。 所有参与的验证者的信息都会合并，使得网络可以达成关于区块链状态的共识。


认证是验证者对于链的状态和区块的投票，它们有助于保持网络的安全和活跃。每个时段（6.4 分钟），验证者会被分配到一个委员会，每个委员会对应一个子网。验证者会在子网上广播他们的认证，然后由一个聚合者收集并聚合这些认证，最后由一个区块提议者将聚合的认证包含到新的区块中。1

聚合者Aggregator

## 6.权益证明机制的奖励和惩罚

## 7.权益证明攻击与防御

## 8.密钥

## 9.提出区块

### 9.1 谁产生区块？

在每个时隙slot以伪随机的方式选择一个验证者来提议区块。 以太坊使用一种叫做 RANDAO 的算法来实现随机性。  
每个时隙slot中会选择一个区块提议者。在正常情况下，单个区块生产者会在他们专属的时隙slot中创建并发布单个区块。  
为同一个时隙slot创建两个区块是一种可罚没的行为，通常被称为“模棱两可equivocation”。  

验证者的选择提前两个时段epoch固定

### 区块是如何创建的？

每个验证者只是偶尔负责提议一个区块。以太坊以时隙slot和时段epoch来度量时间。每个时隙slot是12秒，32个时隙slot(6.4 分钟)组成一个时段epoch。每个时隙slot都是在以太坊上添加一个新区块的机会。


### 区块发生了什么？
区块被添加到区块提议者的本地数据库，并通过共识层广播网络广播给对等者。 当一个验证者接收到区块时，它会验证其中的数据，包括检查区块是否有正确的父区块、是否对应正确的时隙、提议者索引是否符合预期、RANDAO 揭示是否有效以及提议者是否被罚没。 execution_payload 被解包，验证者的执行客户端重新执行列表中的交易，以检查所提议的状态变化。 假设区块通过了所有这些检查，每个验证者将区块添加到自己的规范链中。 然后，在下一个时隙中重新开始这个过程。

### 区块奖励
区块提议者会收到他们工作的报酬。 有一个 base_reward，它是根据活跃验证者的数量和他们的有效余额来计算的。 然后，区块提议者会收到区块中包含的每个有效认证的 base_reward 的一部分；认证区块的验证者越多，区块提议者获得的奖励就越高。 还有一个奖励是报告应该被罚没的验证者，数额等于每个被罚没的验证者的 1/512 * effective balance。


## 10.常见问题

### 验证者是如何被选中的？

每个时隙都会以伪随机的方式选择一个验证者来提议区块，使用的算法被称为 RANDAO，它将区块提议者的哈希与一个随每个区块更新的种子混合在一起。 这个值用于在所有验证者中选择一个特定的验证者。 验证者的选择会提前四个时段固定。

### 以太坊的权益证明系统会受到 51% 攻击吗？

由此可见， 权益证明和工作量证明一样，容易受到 51% 攻击。 攻击者不需要掌控 51% 的网络算力，而是需要掌控已质押以太币总数的 51%。 如果攻击者累积了总质押量的 51％，则能够控制分叉选择算法。 这使得攻击者能够审查某些交易，进行短程重组，以及通过以有利于他们的方式重新排序区块来提取矿工可提取价值。

### 验证者是如何被选中的？

每个时隙都会以伪随机的方式选择一个验证者来提议区块，使用的算法被称为 RANDAO，它将区块提议者的哈希与一个随每个区块更新的种子混合在一起。 这个值用于在所有验证者中选择一个特定的验证者。 验证者的选择会提前四个时段固定。

----------------------------------------------

## PS 汉英翻译

时段 epoch
时隙 slot
检查点 checkpoint
信标链 beacon chain
聚合者 Aggregator
弱主观性 Weak Subjectivity
认证 attestation


**参考**  
https://ethereum.org/zh/glossary/
https://github.com/ethereum/pos-evolution/blob/master/pos-evolution.md
https://ethos.dev/beacon-chain
⅔

----------------------------------------------
欢迎大家的意见和交流

`email: li_mingxie@163.com`
